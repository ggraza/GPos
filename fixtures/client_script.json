[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "promotion",
  "enabled": 1,
  "modified": "2025-08-25 15:35:30.861759",
  "module": "Gpos",
  "name": "promotion uom",
  "script": "frappe.ui.form.on(\"promotion\", {\r\n    setup(frm) {\r\n        console.log(\"Promotion form setup triggered\", frm);\r\n\r\n        // Restrict UOM in item_table rows to only the item's defined UOMs\r\n        frm.set_query(\"uom\", \"item_table\", function (doc, cdt, cdn) {\r\n            const row = locals[cdt][cdn];\r\n            console.log(\"Set query for UOM called for row:\", row);\r\n\r\n            if (!row?.item_code) {\r\n                console.log(\"No item_code in row, returning empty query\");\r\n                return {};\r\n            }\r\n\r\n            console.log(\"Applying filter for item_code:\", row.item_code);\r\n            return {\r\n                query: \"erpnext.controllers.queries.get_item_uom_query\",\r\n                filters: { item_code: row.item_code },\r\n            };\r\n        });\r\n\r\n        console.log(\"Setup complete for promotion form\");\r\n    },\r\n});\r\n\r\nfrappe.ui.form.on(\"Item child table\", {\r\n    item_code(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        console.log(\"item_code change detected in child table row:\", row);\r\n\r\n        if (!row) {\r\n            console.log(\"Row not found, aborting\");\r\n            return;\r\n        }\r\n\r\n        console.log(`Clearing UOM for row with item_code ${row.item_code}`);\r\n        frappe.model.set_value(cdt, cdn, \"uom\", \"\");\r\n\r\n        console.log(\"UOM cleared for row:\", locals[cdt][cdn]);\r\n    },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "promotion",
  "enabled": 0,
  "modified": "2025-08-21 10:33:57.535050",
  "module": "Gpos",
  "name": "priceadding in promotion",
  "script": "frappe.ui.form.on('Item child table', {\r\n    item_code: function(frm, cdt, cdn) {\r\n        frappe.msgprint(\"ðŸ†• Item Code field triggered\");\r\n\r\n        let row = locals[cdt][cdn];\r\n        frappe.msgprint(\"ðŸ“Œ Selected Item Code: \" + row.item_code);\r\n\r\n        if (row.item_code) {\r\n            if (frm.doc.custom_price_list) {\r\n                frappe.msgprint(\"âœ… Price List exists: \" + frm.doc.custom_price_list);\r\n\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Item Price\",\r\n                        filters: {\r\n                            item_code: row.item_code,\r\n                            price_list: frm.doc.custom_price_list\r\n                        },\r\n                        fields: [\"price_list_rate\"],\r\n                        limit_page_length: 1\r\n                    },\r\n                    callback: function(res) {\r\n                        frappe.msgprint(\"ðŸ“¡ API Call Returned for: \" + row.item_code);\r\n\r\n                        if (res.message && res.message.length > 0) {\r\n                            let price = res.message[0].price_list_rate;\r\n                            frappe.msgprint(\"âœ… Found Price: \" + price);\r\n                            frappe.model.set_value(cdt, cdn, \"sale_price\", price);\r\n\r\n                            // also trigger discount calculation when sale price is fetched\r\n                            calculate_discount(row, cdt, cdn);\r\n                        } else {\r\n                            frappe.msgprint(\"âŒ No Price Found for \" + row.item_code + \" in Price List \" + frm.doc.custom_price_list);\r\n                            frappe.model.set_value(cdt, cdn, \"sale_price\", 0);\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                frappe.msgprint(\"âš ï¸ No Price List selected while choosing Item Code\");\r\n            }\r\n        } else {\r\n            frappe.msgprint(\"âš ï¸ Item Code is empty\");\r\n        }\r\n    },\r\n\r\n    discount_type: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        calculate_discount(row, cdt, cdn);\r\n    },\r\n\r\n    discount_percentage: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        calculate_discount(row, cdt, cdn);\r\n    },\r\n\r\n    discount_amount: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        calculate_discount(row, cdt, cdn);\r\n    }\r\n});\r\n\r\n\r\n// ðŸ”½ Helper Function\r\nfunction calculate_discount(row, cdt, cdn) {\r\n    let sale_price = flt(row.sale_price) || 0;\r\n    let price_after_discount = sale_price;\r\n\r\n    if (row.discount_type === \"Discount Percentage\") {\r\n        let discount_percentage = flt(row.discount_percentage) || 0;\r\n        price_after_discount = sale_price - (sale_price * discount_percentage / 100);\r\n\r\n    } else if (row.discount_type === \"Discount Amount\" || row.discount_type === \"Rate\") {\r\n        let discount_amount = flt(row.discount__amount) || 0;\r\n        price_after_discount = sale_price - discount_amount;\r\n    }\r\n\r\n    frappe.model.set_value(cdt, cdn, \"price_after_discount\", price_after_discount);\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Label Printing",
  "enabled": 1,
  "modified": "2025-08-26 16:17:18.139760",
  "module": "Gpos",
  "name": "For Label Printing",
  "script": "frappe.ui.form.on('Label Printing', {\r\n    item_code: function(frm) {\r\n        if (!frm.doc.item_code) return;\r\n\r\n        // Fetch Item and set UOM filter\r\n        frappe.db.get_doc(\"Item\", frm.doc.item_code).then(item => {\r\n            let allowed_uoms = [];\r\n\r\n            if (item.uoms && item.uoms.length > 0) {\r\n                allowed_uoms = item.uoms.map(row => row.uom);\r\n            } else if (item.stock_uom) {\r\n                allowed_uoms = [item.stock_uom];\r\n            }\r\n\r\n            // Restrict UOM field to allowed UOMs\r\n            frm.set_query(\"uom\", () => {\r\n                return {\r\n                    filters: [[\"UOM\", \"name\", \"in\", allowed_uoms]]\r\n                };\r\n            });\r\n\r\n            // Optionally auto-set if only one UOM exists\r\n            if (allowed_uoms.length === 1) {\r\n                frm.set_value(\"uom\", allowed_uoms[0]);\r\n            }\r\n\r\n            // Do NOT set barcode here â€” wait for UOM selection\r\n            frm.set_value(\"barcode\", \"\"); \r\n        });\r\n    },\r\n\r\n    uom: function(frm) {\r\n        if (!frm.doc.item_code || !frm.doc.uom) return;\r\n\r\n        // Fetch Item to get barcodes\r\n        frappe.db.get_doc(\"Item\", frm.doc.item_code).then(item => {\r\n            if (item.barcodes && item.barcodes.length > 0) {\r\n                // Find the barcode that matches the selected UOM\r\n                let matched = item.barcodes.find(b => b.uom === frm.doc.uom);\r\n                if (matched) {\r\n                    frm.set_value(\"barcode\", matched.barcode);\r\n                } else {\r\n                    frm.set_value(\"barcode\", \"\"); // clear if no match\r\n                }\r\n            } else {\r\n                frm.set_value(\"barcode\", \"\"); // clear if no barcodes\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Label Printing",
  "enabled": 1,
  "modified": "2025-08-27 07:39:21.021571",
  "module": "Gpos",
  "name": "Update Price From Price List",
  "script": "frappe.ui.form.on('Label Printing', {\r\n    update_price_from_price_list: function(frm) {\r\n        if (!frm.doc.item_code || !frm.doc.uom || !frm.doc.price_list) {\r\n            frappe.msgprint(__('Please select Item, UOM and Price List first.'));\r\n            return;\r\n        }\r\n\r\n        // Fetch Item Price\r\n        frappe.db.get_value(\"Item Price\", \r\n            {\r\n                item_code: frm.doc.item_code,\r\n                price_list: frm.doc.price_list,\r\n                uom: frm.doc.uom\r\n            },\r\n            \"price_list_rate\"\r\n        ).then(r => {\r\n            if (r && r.message && r.message.price_list_rate) {\r\n                frm.set_value(\"price_to_print\", r.message.price_list_rate);\r\n            } else {\r\n                frappe.msgprint(__('No Price found for this Item, Price List and UOM.'));\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 }
]